// hypothalamus.js
const express = require('express');
const axios = require('axios'); // We'll use this to call the AI APIs
const app = express();
app.use(express.json());

// --- 1. Homeostasis: AI Health Monitoring ---ssss
// This is the "hypothalamus" sensing the body's state.
// In a real app, this data would come from live ping tests.
const aiHealth = {
  // Melchior (Logic)
  gemini: {
    status: 'online',
    latency: 250, // in ms
    endpoint: 'https://api.google.com/gemini...', // Your actual API endpoint
  },
  // Balthasar (Safety)
  claude: {
    status: 'online',
    latency: 400,
    endpoint: 'https://api.anthropic.com/...',
  },
  // Casper (Humanity/Backup)
  gpt: {
    status: 'online',
    latency: 700,
    endpoint: 'https://api.openai.com/...',
  },
};

// --- 2. Regulation: The "Master Gland" API Endpoint ---
// This is the "conscious thought" request from your MAGI system.
// Your chat app will call THIS endpoint, not the AI APIs directly.
app.post('/magi-query', async (req, res) => {
  const { prompt } = req.body;
  
  console.log('[Hypothalamus] Received MAGI query:', prompt);

  // --- Automatic Regulation (Smart Routing) ---
  // Simple logic: Try the fastest model first.
  // If it fails, try the next fastest.
  
  let chosenAI = null;

  if (aiHealth.gemini.status === 'online' && aiHealth.gemini.latency < 1000) {
    chosenAI = aiHealth.gemini;
    console.log('[Hypothalamus] Routing to MELCHIOR (Gemini)');
  } else if (aiHealth.claude.status === 'online' && aiHealth.claude.latency < 1000) {
    chosenAI = aiHealth.claude;
    console.log('[Hypothalamus] Routing to BALTHASAR (Claude)');
  } else {
    chosenAI = aiHealth.gpt;
    console.log('[Hypothalamus] Routing to CASPER (GPT) as fallback');
  }

  try {
    // --- THIS IS A MOCK CALL ---
    // In a real app, you would use 'axios' to call chosenAI.endpoint
    // const response = await axios.post(chosenAI.endpoint, { prompt }, { headers: ... });
    // const aiData = response.data;

    // Simulating a successful AI call
    const mockResponse = {
      text: `Mock response from ${chosenAI.endpoint.split('.')[1]} for: "${prompt}"`,
    };

    // Send the AI's response back to the original caller (your chat server)
    res.json(mockResponse);

  } catch (error) {
    console.error(`[Hypothalamus] AI call to ${chosenAI.endpoint} failed:`, error.message);
    res.status(500).json({ error: 'AI processing failed' });
  }
});

// --- 3. The "Event Bus" (Async Queue) ---
// This is for tasks you want done, but not *right now*.
// Your chat server calls this and gets an INSTANT reply.
const messageQueue = []; // Simple in-memory queue

app.post('/chat-message-async', (req, res) => {
  const { room, user, message } = req.body;
  
  // 1. Add task to the queue
  messageQueue.push({ room, user, message, timestamp: Date.now() });
  console.log(`[Hypothalamus] Queued message from ${user}. Queue size: ${messageQueue.length}`);
  
  // 2. Respond IMMEDIATELY.
  // This tells the chat server "Got it, I'll handle it."
  // The chat server is now free and doesn't wait.
  res.status(202).json({ status: 'queued' });
});

// --- 4. Background "Brainstem" Processes ---
// This simulates the "hypothalamus" doing its own thing,
// like processing the queue or monitoring health.

// This function processes one item from the queue
async function processQueue() {
  if (messageQueue.length === 0) {
    return; // Queue is empty
  }

  // Get the oldest message
  const task = messageQueue.shift(); 
  console.log(`[Hypothalamus] De-queued: Processing message from ${task.user}...`);
  
  // Now, you could send this to an AI for moderation,
  // save it to a database, etc.
  // Let's just simulate work.
  await new Promise(resolve => setTimeout(resolve, 500)); // Simulate 0.5s of work
  console.log(`[Hypothalamus] Finished processing message from ${task.user}`);
}

// This function simulates live health monitoring
function updateAIHealth() {
  // Mock logic: 1 in 10 chance for an AI to go "offline"
  for (const ai in aiHealth) {
    if (Math.random() < 0.1) {
      aiHealth[ai].status = 'offline';
      console.warn(`[Hypothalamus] SENSE: ${ai} just went OFFLINE`);
    } else {
      aiHealth[ai].status = 'online';
      // Simulate random latency
      aiHealth[ai].latency = Math.floor(Math.random() * (1200 - 200) + 200); 
    }
  }
}

// Start the background processes
setInterval(processQueue, 3000); // Check the queue every 3 seconds
setInterval(updateAIHealth, 10000); // Check AI health every 10 seconds

app.listen(3002, () => {
  console.log('ðŸ§  Hypothalamus Service running on port 3002');
});